## MutTracer

MutTracer (Mutation-guided Temporal State Inference) is a unified framework for single-cell data that performs generation-aware joint modeling of mutational and transcriptional dynamics. It allows reconstruction of temporally resolved cellular lineages by predicting both ancestral and future cellular states while integrating mutational and transcriptional information.

MutTracer can order cells by generation (N) obtained from `scMut`, or by explicitly provided multi-timepoint annotations when available. It leverages both mutational and transcriptional latent representations to infer cellular states across generations.

---

## Framework Overview

### Input Data
- **--model_path**  
  Path to a pre-trained `scMut` model (`.pkl`). This model is trained on sparse mutation matrices to infer the cellular generation index (CGI, N) and provides weights for encoding mutational latent representations (`Zm`).

- **--zmt_path**  
  Path to the mutational latent representation dictionary (`.pt`) generated from the pre-trained `scMut` model. Example of generating `Zm`:

  ```python
  mut_model = load_model('/path/to/model_zt_334.pkl')
  mut_model.model.eval()
  z_real_dict = {}
  for t in sorted(index_map.keys()):
      start, end = index_map[t]
      X_t = torch.tensor(X_concat[start:end], dtype=torch.float32).to(device)
      with torch.no_grad():
          outs = mut_model.model(X_t, train_np=True)
          mu = outs[2]   # latent mu
      z_real_dict[t] = mu.cpu()
  torch.save(z_real_dict, '/path/to/z_grouped_by_celltype.pt')
  ```
- **--zxt_path**  
Path to the transcriptional latent representation dictionary (.pt) generated by scVI. Use core/process_zxt.py to extract Zx from the expression h5ad.

- **---adata_path**  
Path to the original single-cell .h5ad file for alignment and downstream analysis.

- **---scvi_model_path**  
Path to the pre-trained scVI model (.pkl) used to get transcriptional embeddings and reconstruct expression. Use core/process_zxt.py to get scVI model from the expression h5ad.

- **--input_times**  
List of time points to use as input for training.

- **--predict_times**  
List of time points for which MutTracer predicts latent and transcriptional states.

- **--save_dir**  
Directory to save training results, plots, and predictions.

- **--auto_ancestor (optional)**  
Automatically selects the most compact time point as ancestral state.

- **--real_times_keep (optional)**  
Subset of real time points to show in filtered visualizations.

- **--real_times_keep (optional)**  
Subset of predicted time points to show in filtered visualizations.

### Feature Projection and Fusion

1. `Zm` is transformed via a Multi-Layer Perceptron (MLP) projection to emphasize lineage-related mutational features.  
2. `Zx` is mapped through a linear projection layer.  
3. The projected features are concatenated and fed into a bidirectional LSTM (BiLSTM) to model forward and backward temporal dependencies across generations.

### Dynamic Weighting and Modality Separation

1. The BiLSTM outputs a fused hidden representation.  
2. A learnable Weight Net generates dynamic modality-specific weights, separating the fused representation into mutational and transcriptional components.  
3. Each component is passed through a linear projection head to produce the predicted transcriptional and mutational states at each generation.

### Output

- Predicted `N` (generation index) and `X` (expression matrix) for each generation `t±1`.  
- Supports inference of both ancestral (`t−1`) and future (`t+1`) cellular states, enabling temporally resolved reconstruction of lineage dynamics.

---


# Setup environment

conda env create -f environment.yml
conda activate sc_vae_pytorch






