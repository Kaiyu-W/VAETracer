# VAETracer
Mutation-Guided Lineage Reconstruction and Generational State Inference from scRNA-seq

VAETracer is a computational framework that integrates somatic mutation profiles with single-cell RNA equencing (scRNA-seq) data to reconstruct lineage relationships and infer generational dynamics. It consists of three modular components: `preprocess`, `scMut`, and `MutTracer`, implementing end-to-end analysis from raw sequencing data to lineage-aware expression modeling.


## 1. Components of VAETracer

### 1) preprocess: Data Preprocessing Pipeline

The preprocessing module converts raw sequencing data into structured mutation profiles for downstream analysis. 

#### Workflow
```bash
# (optional) Convert SRA to FASTQ
bash SRAtoFastq.sh

# Fastqs to generate gene expression matrix (GEX) and BAM
bash RunCellranger.sh 

# Align scRNA-seq maps using STAR
bash RunSTAR.sh

# Call variants using GATK best practices
bash RunGATK.sh

# Extract allele frequency (AF) matrix from VCF and single-cell BAM
python GetAF.py

# All scripts support --help for detailed usage instructions.
```

### 2) scMut: Mutation Matrix Decomposition

The `scMut` module decomposes the 2D mutation profile **M** into two biologically interpretable components:

- **N**: Cell generation index (lineage time)
- **P**: Site-specific mutation rate (mutation bias)

It consists of three submodules:

- `NMF`: Non-negative Matrix Factorization, for initial and best decomposition
- `VAE`: Variational Autoencoder, with two operational modes:
  <pre>
  ● mode1-`np`: 
      ▪ Infers latent representation Z via encoder:        Z = encoder1(M)
      ▪ Encodes Z -> N through a learned transformation:   N = encoder2(Z)
      ▪ Learns P as site-specific parameters:              P = P_site
      ▪ Reconstructs M by combining N and P:               Mhat = f(N, P)

  ● mode2-`xhat`: 
      ▪ Uses standard encoder-latent-decoder structure:    Z = encoder(M)
      ▪ Reconstructs mutation matrix directly:             Mhat = decoder(Z)
  </pre>
- `FT`: Fine-tuning module, for post-hoc refinement of N and P estimates

#### Python API
```python
# Simulate synthetic data
from scMut import simulate_data, simulate_lineage_data, simulate_lineage_data_segment

# Core model class
from scMut import MutModel

# Run test pipeline
from scMut.test import run_pipe

# Use help(func) in Python to view detailed documentation for each function.
```

### 3) MutTracer: Lineage-Aware Expression Dynamics Modeling

`MutTracer` integrates inferred lineage information with gene expression to predict temporal gene expression patterns along lineages. 
#### Command-Line Usage

```bash
python -m MutTracer.main \
  --model_path <path_to_trained_model.pkl> \
  --zmt_path <path_to_zm_dictionary.pt> \
  --zxt_path <path_to_zx_dictionary.pt> \
  --input_times <list_of_input_timepoints> \
  --predict_times <list_of_timepoints_to_predict> \
  --epochs <num_training_epochs> \
  --adata_path <path_to_original_h5ad_file> \
  --scvi_model_path <path_to_scvi_model.pkl> \
  --save_dir <output_directory> \
  [--auto_ancestor] \
  [--real_times_keep <list_of_times>] \
  [--pred_times_keep <list_of_times>]
```


### Parameter Descriptions

- `--model_path`  
  Path to a pre-trained MutTracer model `.pkl` file. Used to initialize the predictor weights.

- `--zmt_path`  
  Path to the mutational latent representation dictionary (`Zm`) saved in `.pt` format. Typically generated by `scMut`.

- `--zxt_path`  
  Path to the transcriptional latent representation dictionary (`Zx`) saved in `.pt` format. Typically generated by `scVI` on normalized scRNA-seq data.

- `--input_times`  
  List of time points to use as **input** for training or prediction. Only data from these time points will be used as the model's known states.

- `--predict_times`  
  List of time points for which MutTracer will predict latent and transcriptional states.

- `--epochs`  
  Number of training epochs to run during model fitting. Default is `500`. Increasing epochs may improve convergence but increases runtime.

- `--adata_path`  
  Path to the original `.h5ad` single-cell AnnData object, used for downstream gene expression alignment and analysis.

- `--scvi_model_path`  
  Path to a pre-trained scVI model `.pkl` file, used to obtain transcriptional latent embeddings and reconstruct expression profiles.

- `--save_dir`  
  Directory to save training results, plots, and predictions. If the folder does not exist, it will be created.

- `--auto_ancestor` (optional flag)  
  Automatically selects the most compact time point as the **ancestral state** for prediction.

- `--real_times_keep` (optional)  
  Subset of real time points to include in filtered visualizations (e.g., t-SNE or N distribution plots).

- `--pred_times_keep` (optional)  
  Subset of predicted time points to include in filtered visualizations.

### Example Usage

```bash
python -m MutTracer.main \
  --model_path ./model.pkl \
  --zmt_path ./z_mt.pt \
  --zxt_path ./z_xt.pt \
  --input_times 2 3 \
  --predict_times 1 \
  --epochs 2000 \
  --real_times_keep 2 3 \
  --pred_times_keep 1 \
  --auto_ancestor \
  --adata_path ./scRNAlistep.h5ad \
  --scvi_model_path ./scvi_model.pkl \
  --save_dir ./output
```
This command will train MutTracer using time points 2 and 3 as input, predict states for time point 1, automatically select an ancestral state, and save all results and plots to the specified save_dir.

### 4) tree_util: Lineage tree utilities

Provides utility functions for lineage tree processing and format interoperability:

- Converts between `Newick` string format and `CassiopeiaTree` object
- Fixes common tree format issues to improve stability
- Other utilities: e.g. extracts tree linkage matrix


## 2. Environment Installation

Due to dependency conflicts among packages, we provide ``env_split.sh`` to automatically set up three isolated Conda environments:

1) **VAETracer_vcf**
    - For upstream data processing
    - Dependencies:
`sra-tools`, `samtools`, `vcftools`, `gatk`, `STAR`, `pysam`, `pyarrow` 
    - Recommended version consistency with scripts for compatibility

2) **VAETracer_vae**
    - For scMut modeling and decomposition
    - Dependencies:
`pytorch`, `pyarrow`, `scipy`, `scikit-learn`, `umap-learn,` `scanpy`

3) **VAETracer_sc**
    - For downstream analysis with scRNA-seq data
    - Dependencies:
`scanpy` (for single-cell analysis), `cassiopeia` (for lineage tree construction), and others

Alternatively, users may manually create the environments and configure the corresponding dependencies as needed.

## 3. Notes and Recommendations

- Ensure consistent software versions across pipeline steps to avoid compatibility issues.

For questions, please contact.
